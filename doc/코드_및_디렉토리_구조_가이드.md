# 패션 Agentic AI 시스템 — 코드 및 디렉토리 구조 가이드

각 디렉토리·핵심 파일의 **기능**, **특징**, **작동 원리**를 간략히 정리한 문서입니다.

---

## 1. 프로젝트 루트 디렉토리 구조

```
Fashion-Agentic-AI-System_01/
├── .env                    # 환경 변수 (GEMINI_API_KEY, OpenAI_API_Key 등)
├── agentic_system/         # 핵심 에이전트 시스템 (API, Core, Tools, Data, Frontend)
├── doc/                    # 문서 (계획서, 요약본, 가이드)
├── image/                  # 이미지 자산 (종합 시스템 구성도 등)
├── model/                  # InternVL2-8B 등 모델 가중치 (저장소 제외 가능)
├── uploads/                # 사용자 업로드 파일 임시 저장
├── outputs/                # 3D 모델·패턴 등 생성 결과물
├── paper/                  # 논문·아키텍처 분석 문서
├── checkpoints/            # LLaVA 등 체크포인트 (2D-3D 연동용)
└── scripts/                # 프로젝트 루트 스크립트 (parse_pdf 등)
```

---

## 2. agentic_system/ — 핵심 패키지

### 2.1 api/

| 파일 | 기능 | 특징 | 작동 원리 |
|------|------|------|-----------|
| **main.py** | FastAPI 메인 서버 | CORS, .env 로드, GEMINI/OpenAI 키 주입 | 앱 기동 시 MemoryManager·RAGStore·AgentRuntime·F.LLM 초기화 → `/api/v1/request`(multipart), `/api/v1/request/json`, 세션/파일 API 노출. 요청 시 CustomUI로 Payload 생성 후 AgentRuntime.process_request() 호출, 결과를 format_output으로 반환 |

- **역할**: HTTP 진입점. 클라이언트 요청을 에이전트 파이프라인으로 넘기고 JSON 응답 반환.

---

### 2.2 core/

| 파일 | 기능 | 특징 | 작동 원리 |
|------|------|------|-----------|
| **agent_runtime.py** | Agent 1 (종합 감독 에이전트) | 인식·판단·행동 3단계 오케스트레이션, 도구 등록/실행, 자기 수정 루프 | 1) _analyze_user_intent()로 의도 분류(대화/정보/3D생성/의류추천) 2) 채팅 전용이면 _respond_conversation 또는 _respond_with_rag로 즉시 응답 3) 아니면 _create_abstract_plan → RAG get_context → agent2.generate_execution_plan → _execute_plan → _self_correction_loop. tools_registry에 등록된 도구를 step 순서대로 호출 |
| **f_llm.py** | Agent 2 (작업 지시 전문가) | 추상 계획 → 실행 계획(JSON) 생성 | AbstractPlan 수신 후 plan_type(3d_generation / garment_recommendation)에 따라 _create_3d_generation_steps 또는 _create_recommendation_steps로 ExecutionPlan.steps 생성. RAG 컨텍스트로 계획 보강(_enhance_with_rag). PoC에서는 use_llm_for_now=False로 규칙 기반만 사용, InternVL2는 선택적 |
| **memory.py** | 메모리 관리 | 단기(세션)/장기 메모리 추상화 | MemoryManager가 session_id별 ShortTermMemory 보관. ShortTermMemory는 conversation_history(deque), context 저장. add_conversation(), get_conversation_history(), get_context() 제공. PoC는 단기만 사용 |
| **custom_ui.py** | 입력/출력 어댑터 | 텍스트·이미지 → Payload, API 결과 → 클라이언트용 JSON | process_user_input(): text, image_path, session_id → input_data, has_image 등 포함한 Payload 생성. format_output(): AgentRuntime 결과에 chat_only·thoughts 반영해 응답 구조 정리 |

---

### 2.3 tools/

| 파일 | 기능 | 특징 | 작동 원리 |
|------|------|------|-----------|
| **gemini_tryon.py** | 가상 피팅 도구 | Google Gemini API 기반 의류 분석·Try-On | GeminiTryOnTool.execute(action, parameters, context): analyze_image(의류 이미지 분석), try_on(가상 피팅 이미지 생성). API 키 없으면 Mock 응답. main.py에서 gemini_tryon_tool로 등록되어 Agent Runtime이 step 실행 시 호출 |
| **functions.py** | 상품 검색 등 Function 도구 | Mock/실제 상품 검색 | product_search_function_tool(action, parameters, context): garment_recommendation 경로에서 호출. PoC에서는 Mock 목록 반환 가능 |

---

### 2.4 data_stores/

| 파일 | 기능 | 특징 | 작동 원리 |
|------|------|------|-----------|
| **rag.py** | RAG 스토어 통합 | Mock + 내부(로컬) + 외부(웹) RAG | RAGStore.get_context(plan_type, user_input): local_rag.get_context()로 로컬 문서 검색, external_rag.get_context()로 웹 검색, mock get_rag_context로 패션 규칙 보강 → rag_suggestions 등 하나로 합쳐 반환. Agent 2 계획 강화·채팅 응답에 사용 |
| **rag_local.py** | 로컬 문서 RAG | doc/, local_rag_docs, rag_fashion_1gb의 .txt/.md 청크 검색 | LocalRAG: _load_documents()로 위 디렉터리 순회 후 _chunk_text()로 청크화. search(query): 키워드/문자열 매칭으로 점수 부여 후 top_k 반환. get_context()는 검색 결과를 suggestions 형태로 제공 |
| **rag_external.py** | 외부(웹) RAG | DuckDuckGo 또는 Serper API 검색 | 사용자 쿼리로 웹 검색해 스니펫 수집, get_context()에서 suggestions 리스트 반환. API 키 없으면 스킵 가능 |

---

### 2.5 models/

| 파일 | 기능 | 특징 | 작동 원리 |
|------|------|------|-----------|
| **internvl2_wrapper.py** | InternVL2-8B 래퍼 | Vision-Language 모델 로딩·텍스트 생성 | 모델 경로 자동 감지, load_model()로 로드. generate_text(prompt, image_path, max_new_tokens): 이미지+텍스트 입력 시 멀티모달 추론. F.LLM에서 use_llm_for_now=True일 때 계획 생성에 사용(현재는 비활성) |

---

### 2.6 scripts/

| 파일 | 기능 | 특징 | 작동 원리 |
|------|------|------|-----------|
| **collect_fashion_rag_data.py** | RAG 1GB 수집 | Wikipedia·큐레이션으로 패션 데이터 수집 | 위키 검색/카테고리로 문서 수집, rag_fashion_1gb에 wiki_*.txt 저장. 1GB 미달 시 연속 2라운드 새 문서 없으면 curated_glossary_*.txt 대용량 파일 추가. get_total_size_all_txt()로 1GB 도달 시 중단 |
| **verify_rag_1gb.py** | RAG 1GB 검증 | 셀프 점검 | rag_fashion_1gb 내 .txt 파일 수·총 바이트 계산, 1GB 이상 여부 출력 |
| **test_rag.py** | RAG 동작 테스트 | CLI 검증 | RAGStore.get_context() 호출 후 rag_internal·rag_external·rag_suggestions 출력. 로컬/외부 RAG 정상 여부 확인용 |

---

### 2.7 data/

| 디렉토리/역할 | 기능 | 특징 | 작동 원리 |
|---------------|------|------|-----------|
| **local_rag_docs/** | 로컬 RAG 문서 | 기본 로컬 문서 폴더 | rag_local.py에서 .txt/.md 로드해 청크 검색 대상으로 사용 |
| **rag_fashion_1gb/** | 패션 RAG 대용량 데이터 | wiki_*.txt, curated_*.txt | collect_fashion_rag_data.py로 채움. LocalRAG가 이 폴더도 스캔해 정보 검색에 활용 |

---

### 2.8 frontend/ — React + Vite 프론트엔드

#### 2.8.1 진입점·설정

| 파일 | 기능 | 특징 | 작동 원리 |
|------|------|------|-----------|
| **src/main.jsx** | React 진입점 | App 마운트 | ReactDOM.createRoot로 App을 #root에 렌더링 |
| **src/App.jsx** | 최상위 앱 컴포넌트 | 상태·API 연동·레이아웃 | image, text, messages, result, sessionId 상태 관리. SimplePromptBar에서 입력 → POST /api/v1/request → 응답을 messages/result에 반영. ChatArea에 채팅, ResultViewer에 실행 결과(thoughts·시각화). POCPillar(activeSteps), StatusBar(상태) |
| **vite.config.js** | Vite 빌드 설정 | 프록시·경로 | 개발 서버 설정, 필요 시 API 프록시 |
| **package.json** | 의존성·스크립트 | React, axios, Three.js, Vite | npm run dev / build / preview |

#### 2.8.2 components/

| 파일 | 기능 | 특징 | 작동 원리 |
|------|------|------|-----------|
| **SimplePromptBar.jsx** | 한 줄 입력바 | 텍스트 입력, + 드롭다운(사진·파일), 마이크, 보내기 버튼 | placeholder "무엇을 도와드릴까요?", onSubmit 시 부모의 전송 로직 호출, 이미지 첨부 시 부모 setImage |
| **ChatArea.jsx** | 채팅 영역 | 사용자/AI 메시지 목록 표시 | messages 배열을 role별로 구분해 말풍선 렌더링. openai_error 시 "OpenAI API를 사용할 수 없습니다" 등 안내 |
| **ResultViewer.jsx** | 실행 결과 뷰어 | 완료 상태·thoughts(의도·추상계획·실행계획)·전체 데이터 접기/펼치기 | result.chat_only가 false일 때만 표시. thoughts 패널로 2단계(판단) 내용 표시, VoiceOutput(듣기) 포함 |
| **StatusBar.jsx** | 상태 바 | 상태 라벨·색 구분(완료=연두, 실패=빨강 등) | result.status 또는 loading에 따라 "완료"/"실행 중"/"실패" 등 텍스트·배경색 변경 |
| **POCPillar.jsx** | POC 안내 사이드바 | 인식→판단→행동 단계, 종합 시스템 구성도, 21가지 패턴 요약 | 접기/펼치기, activeSteps로 1·2·3 활성 표시. "종합 시스템 구성도" 클릭 시 이미지 모달(줌/패닝). "21가지 패턴 & POC 요약" 클릭 시 풀스크린 안내 패널(5개 적용 패턴·16개 예정·ADK 설명) |
| **VoiceInput.jsx** | 음성 입력 | Web Speech API | 마이크 클릭 시 음성 인식 시작, 결과 텍스트를 부모로 전달 |
| **VoiceOutput.jsx** | 음성 출력 | TTS | "듣기" 클릭 시 응답 메시지 읽어줌 |
| **ImageUpload.jsx** | 이미지 업로드 UI | 파일 선택·미리보기 | SimplePromptBar 또는 별도 영역에서 이미지 선택 시 file 전달 |
| **ModelViewer.jsx** | 3D 뷰어 | Three.js 기반 | 3D 모델 URL/데이터 수신 시 캔버스에 렌더링(가상 피팅 결과 등) |
| **ThemeToggle.jsx** | 라이트/다크 테마 전환 | ThemeContext 연동 | 클릭 시 테마 토글, 컨텍스트로 하위 컴포넌트에 전파 |

#### 2.8.3 contexts/

| 파일 | 기능 | 특징 | 작동 원리 |
|------|------|------|-----------|
| **ThemeContext.jsx** | 테마 상태 공유 | 라이트/다크 | Provider로 theme·setTheme 제공, 하위에서 useTheme()로 구독 |

#### 2.8.4 public/

| 항목 | 기능 | 특징 | 작동 원리 |
|------|------|------|-----------|
| **system-diagram.jpg** | 종합 시스템 구성도 이미지 | POCPillar 모달에서 표시 | /system-diagram.jpg로 서빙, image/ 폴더 원본 복사본 |

---

## 3. 프로젝트 루트 기타

| 경로 | 기능 | 특징 | 작동 원리 |
|------|------|------|-----------|
| **doc/문서_분석_요약본.txt** | 계획서·코드베이스 요약 | POC 범위, 5대 패턴, 데이터 플로우 | 텍스트 문서로 설계·구현 현황 정리 |
| **doc/infor.md** | 개발 계획서 본문 | 21가지 패턴, 기술 스택 | 계획서 원본에 가까운 마크다운 |
| **doc/RAG_테스트_안내.md** | RAG 테스트 방법 | CLI·백엔드·프론트 절차 | verify_rag_1gb, test_rag.py, 예시 질문 안내 |
| **model/InternVL2_8B/** | InternVL2-8B 모델 파일 | config, tokenizer, safetensors | Hugging Face 형식, internvl2_wrapper가 로드 |
| **uploads/** | 업로드 임시 저장 | API가 저장한 이미지 | main.py에서 업로드 파일 저장, 도구에 image_path 전달 |
| **outputs/** | 생성 결과물 | 3D 모델, 패턴 등 | 도구 실행 결과 저장 경로 |

---

## 4. 데이터 플로우 요약

1. **클라이언트** → `POST /api/v1/request` (text, image, session_id)
2. **main.py** → 이미지 저장, CustomUI.process_user_input() → Payload
3. **AgentRuntime.process_request()**  
   → 의도 분석 → (채팅 전용이면 RAG/대화 응답 후 종료)  
   → 추상 계획 생성 → RAG get_context → F.LLM으로 실행 계획 생성  
   → _execute_plan()으로 도구 순차 호출 → _self_correction_loop()로 평가·재시도
4. **memory.add_conversation()** → ShortTermMemory에 기록
5. **custom_ui.format_output()** → JSON 응답 → **클라이언트** (messages, result, thoughts 등)

---

## 5. 핵심 코드 위치 요약표

| 목적 | 파일(경로) |
|------|------------|
| API 진입점 | agentic_system/api/main.py |
| Agent 1 오케스트레이션 | agentic_system/core/agent_runtime.py |
| Agent 2 실행 계획 생성 | agentic_system/core/f_llm.py |
| 세션 메모리 | agentic_system/core/memory.py |
| 입력/출력 포맷 | agentic_system/core/custom_ui.py |
| 가상 피팅 도구 | agentic_system/tools/gemini_tryon.py |
| RAG 통합 | agentic_system/data_stores/rag.py |
| 로컬 RAG 검색 | agentic_system/data_stores/rag_local.py |
| 프론트 앱·상태 | agentic_system/frontend/src/App.jsx |
| POC 안내·구성도·패턴 요약 | agentic_system/frontend/src/components/POCPillar.jsx |

이 문서는 코드·디렉토리 구조와 각 부분의 기능·특징·작동 원리를 한곳에서 참고할 수 있도록 정리한 가이드입니다.
